<!DOCTYPE html>
<html lang="en">
<head>
    <%-include('../../partials/header.ejs')%>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body  >
    <%-include('../../partials/navbaradmin.ejs')%>
    <div class="container-responsive">
        <div class="conteudo">
            <div class="container">
                <div class="lista-reboques">

                    <%
                        const totalGeral = reboques.reduce((total, r) => {
                            return total + Number(r.total);
                        }, 0);
                    %>

                    <div class="container mt-3">
                        <div class="card shadow-sm">
                            <div class="card-body p-3">

                                <!-- TOTAL GERAL -->
                                <div class="text-center mb-3">
                                    <small class="text-muted">Total do perÃ­odo</small><br>
                                    <h5 class="fw-bold text-success mb-0">
                                        R$ <%= totalGeral.toFixed(2) %>
                                    </h5>
                                </div>

                                <!-- LISTA DE REBOQUES -->
                                <% reboques.forEach(function(reboque) { %>
                                    <div class="card mb-2">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">Placa</small><br>
                                                    <strong><%= reboque.reboquePlaca %></strong>
                                                </div>

                                                <div class="text-end">
                                                    <small class="text-muted">Total</small><br>
                                                    <strong class="text-success">
                                                        R$ <%= Number(reboque.total).toFixed(2) %>
                                                    </strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>

                            </div>
                        </div>
                    </div>



                    <div class="container mt-3" >
                        <canvas id="myChart"></canvas>
                    </div>
                    <input type="hidden" id="dataJSON" value="<%=dataJSON%>">

                    <!-- Listagem das reservas -->
                    <div class="container mt-3">
                        <div class="card-body">
                            <h5 class="mb-3">ðŸ“‹ Reservas dos Reboques</h5>

                            <div class="row g-3">
                                <% reservas.forEach(function(reserva, i){ 
                                    let nome = reserva.cliente.nome.trim();
                                    let partes = nome.split(/\s+/);
                                    let primeiroNome = partes[0];
                                    let ultimoNome = partes.length > 1 ? partes[partes.length - 1] : "";

                                    let forma = reserva.pagamento.forma || '';
                                    let formaBadge = forma === 'PIX' ? 'bg-primary' : (forma === 'DINHEIRO' ? 'bg-warning text-dark' : 'bg-secondary');

                                    let sit = reserva.situacaoReserva;
                                    let sitLabel = (sit === 'APROVADO' ? 'Aprovado' : (sit === 'ANDAMENTO' ? 'Em andamento' : (sit === 'AGUARDANDO_ACEITACAO' ? 'Aguardando' : sit)));
                                    let sitBadge = (sit === 'APROVADO' ? 'bg-success' : (sit === 'ANDAMENTO' ? 'bg-info' : (sit === 'AGUARDANDO_ACEITACAO' ? 'bg-warning text-dark' : 'bg-secondary')));
                                %>
                                <div class="col-12 col-md-6 col-lg-4">
                                    <div class="card reserva-card shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1 text-primary fw-bold">
                                                        <i class="fas fa-user me-1"></i><%= primeiroNome %> <%= ultimoNome %>
                                                    </h6>
                                                    <div class="small text-muted">
                                                        <i class="fas fa-trailer me-1"></i><%= reserva.reboque.placa %>
                                                    </div>
                                                </div>
                                                <span class="badge <%= sitBadge %>"><%= sitLabel %></span>
                                            </div>

                                            <div class="mt-2 d-flex justify-content-between align-items-center">
                                                <div class="fw-bold fs-6 text-success">
                                                    R$ <%= (reserva.pagamento.valor).toFixed(2).replace('.',',') %>
                                                </div>
                                                <span class="badge <%= formaBadge %>"><%= forma %></span>
                                            </div>

                                            <button class="btn btn-sm btn-link px-0 mt-2" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#detalhes<%= i %>">
                                                Detalhes <i class="fas fa-chevron-down"></i>
                                            </button>

                                            <div id="detalhes<%= i %>" class="collapse">
                                                <hr class="my-2">
                                                <div class="small">
                                                    <div class="mb-1"><i class="fas fa-phone me-1"></i><%= reserva.cliente.telefone %></div>
                                                    <div class="mb-1"><i class="fas fa-file-alt me-1"></i><%= reserva.cliente.cpf %></div>
                                                    <div class="mb-1">
                                                        <i class="fas fa-dollar-sign me-1"></i>DiÃ¡ria:
                                                        R$ <%= (reserva.pagamento.valor/reserva.diarias).toFixed(2).replace('.',',') %>
                                                        <span class="ms-2"><i class="fas fa-clock me-1"></i>Dia(s): <%= reserva.diarias %></span>
                                                    </div>
                                                    <div class="mb-1">
                                                        <i class="fas fa-calendar-day me-1 text-success"></i>
                                                        InÃ­cio: <%= new Date(reserva.dataSaida).toLocaleDateString('pt-BR') %>
                                                        <%= new Date(reserva.dataSaida).toString().slice(16,18) %>h
                                                    </div>
                                                    <div class="mb-1">
                                                        <i class="fas fa-calendar-check me-1 text-danger"></i>
                                                        Fim: <%= new Date(reserva.dataChegada).toLocaleDateString('pt-BR') %>
                                                        <%= new Date(reserva.dataChegada).toString().slice(16,18) %>h
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-light d-flex justify-content-between">
                                            <div>
                                                <% if(reserva.situacaoReserva == 'APROVADO') { %>
                                                    <a href="/reserva/admin/situacao/<%=reserva.id%>/APROVADO" class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-play me-1"></i>Iniciar
                                                    </a>
                                                <% } else if (reserva.situacaoReserva == 'ANDAMENTO') { %>
                                                    <a href="/reserva/admin/situacao/<%=reserva.id%>/ANDAMENTO" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-stop me-1"></i>Encerrar
                                                    </a>
                                                <% } else if(reserva.situacaoReserva == 'AGUARDANDO_ACEITACAO'){ %>
                                                    <form action="/reserva/admin/pagamento/dinheiro" method="POST" class="d-inline">
                                                        <input type="hidden" name="codigoPagamento" value="<%=reserva.pagamento.codigoPagamento%>">
                                                        <input type="hidden" name="valor" value="<%=reserva.pagamento.valor%>">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-check me-1"></i>Aprovar
                                                        </button>
                                                    </form>
                                                <% } else { %>
                                                    <span class="badge bg-primary"><i class="fas fa-qrcode me-1"></i>PIX</span>
                                                <% } %>
                                            </div>

                                            <a href="/reserva/admin/editar/<%=reserva.id%>" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Editar reserva">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                            </div>

                            <% if(mensagem && mensagem !== '') { %>
                            <div class="alert alert-danger mt-3">
                                <strong><%= mensagem %></strong>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Estilo leve para os cards -->
                    <style>
                    .reserva-card{border-radius:1rem;transition:transform .2s ease,box-shadow .2s ease}
                    .reserva-card:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
                    </style>

                    
                </div>
            </div>
        </div>

        
    </div>

    <script>
        const ctx = document.getElementById('myChart');
        
        let dataJSON = document.getElementById('dataJSON');
        let dataArray = JSON.parse(dataJSON.value);
    
        // ObtÃ©m o nome do mÃªs atual e o Ãºltimo dia do mÃªs
        const monthNames = [
            'Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const now = new Date();
        const currentMonth = monthNames[now.getMonth()]; // Nome do mÃªs atual
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); // Ãšltimo dia do mÃªs
    
        // Paleta de cores para os reboques
        const colors = [
            'rgba(255, 99, 132, 0.2)',  // Vermelho
            'rgba(54, 162, 235, 0.2)',  // Azul
            'rgba(255, 206, 86, 0.2)',  // Amarelo
            'rgba(75, 192, 192, 0.2)',  // Verde Ã¡gua
            'rgba(153, 102, 255, 0.2)', // Roxo
            'rgba(255, 159, 64, 0.2)'   // Laranja
        ];
    
        const borderColors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ];
    
        new Chart(ctx, {
            type: 'bar', // ðŸ”´ mudou de line para bar
            data: {
                datasets: dataArray.datasets.map((dataset, index) => ({
                    ...dataset,
                    backgroundColor: colors[index % colors.length],
                    borderColor: borderColors[index % borderColors.length],
                    borderWidth: 1
                })),
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        font: {
                            size: window.innerWidth < 600 ? 16 : 20,
                        },
                    },
                    legend: {
                        labels: {
                            font: {
                                size: window.innerWidth < 600 ? 10 : 14,
                            },
                        },
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += Number(context.raw.y).toFixed(2);
                                return label;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        type: 'linear', // âœ… pode manter linear (dias do mÃªs)
                        min: 1,
                        max: lastDayOfMonth,
                        ticks: {
                            stepSize: 1,
                        },
                        stacked: true
                    },
                    y: {
                        
                            display: false,
                        
                        stacked: true
                    },
                },
                animation: {
                    duration: 1500, // barra fica melhor com animaÃ§Ã£o mais curta
                    easing: 'easeOutQuart',
                },
            },
        });

    </script>
    
    
    <%-include('../../partials/footer.ejs')%>

</body>
</html>