<!DOCTYPE html>
<html lang="en">
<head>
    <%-include('../../partials/header.ejs')%>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body  >
    <%-include('../../partials/navbaradmin.ejs')%>
    <div class="container-responsive">
        <div class="conteudo">
            <div class="container">
                <div class="lista-reboques">
                
                    <!-- Gr√°ficos      -->
                    <!-- <div class="jumbotron jumbotron-fluid">
                        <div class="container">
                        <h1 class="display-4">Bem-vindo ao Painel do Administrador</h1>
                        <p class="lead">Escolha uma op√ß√£o para gerenciar.</p>
                        </div>
                    </div> -->

                    <div class="card card-reserva" style="width: 45rem;">
                        <canvas id="myChart"></canvas>
                    </div>
                    <input type="hidden" id="dataJSON" value="<%=dataJSON%>">

                    <!-- Listagem das reservas para DESKTOP -->
                    <!-- === LISTAGEM DAS RESERVAS (DESKTOP + MOBILE) === -->
<div class="card card-reserva">
  <div class="card-body">
    <h5 class="mb-3">üìã Reservas dos Reboques</h5>

    <!-- TABELA ‚Äì Desktop (md e acima) -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>A√ß√£o</th>
            <th>Cliente</th>
            <th>Telefone</th>
            <th>Reboque</th>
            <th>Total</th>
            <th>Di√°ria</th>
            <th>Forma</th>
            <th>In√≠cio</th>
            <th>Hora</th>
            <th>Fim</th>
            <th>Hora</th>
            <th>Editar</th>
          </tr>
        </thead>
        <tbody>
          <% reservas.forEach(function(reserva){ %>
            <tr>
              <!-- A√ß√£o -->
              <td>
                <% if(reserva.situacaoReserva == 'APROVADO') { %>
                  <a href="/reserva/admin/situacao/<%=reserva.id%>/APROVADO" class="btn btn-sm btn-info">Iniciar</a>
                <% } else if (reserva.situacaoReserva == 'ANDAMENTO') { %>
                  <a href="/reserva/admin/situacao/<%=reserva.id%>/ANDAMENTO" class="btn btn-sm btn-danger">Encerrar</a>
                <% } else if(reserva.situacaoReserva == 'AGUARDANDO_ACEITACAO'){ %>
                  <form action="/reserva/admin/pagamento/dinheiro" method="POST" class="d-inline">
                    <input type="hidden" name="codigoPagamento" value="<%=reserva.pagamento.codigoPagamento%>">
                    <input type="hidden" name="valor" value="<%=reserva.pagamento.valor%>">
                    <button type="submit" class="btn btn-sm btn-success">Aprovar</button>
                  </form>
                <% } else { %>
                  <span class="badge bg-primary">PIX</span>
                <% } %>
              </td>

              <!-- Cliente (primeiro + √∫ltimo) -->
              <%
                let nome = reserva.cliente.nome.trim();
                let partes = nome.split(/\s+/);
                let primeiroNome = partes[0];
                let ultimoNome = partes.length > 1 ? partes[partes.length - 1] : "";
              %>
              <td><%= primeiroNome %> <%= ultimoNome %></td>

              <td><%= reserva.cliente.telefone %></td>
              <td><%= reserva.reboque.placa %></td>
              <td>R$ <%= (reserva.pagamento.valor).toFixed(2).replace('.',',') %></td>
              <td>R$ <%= (reserva.pagamento.valor/reserva.diarias).toFixed(2).replace('.',',') %></td>
              <td>
                <% if(reserva.pagamento.forma === 'PIX'){ %>
                  <span class="badge bg-primary">PIX</span>
                <% } else if(reserva.pagamento.forma === 'DINHEIRO'){ %>
                  <span class="badge bg-warning text-dark">DINHEIRO</span>
                <% } else { %>
                  <span class="badge bg-secondary"><%= reserva.pagamento.forma %></span>
                <% } %>
              </td>
              <td><%= new Date(reserva.dataSaida).toLocaleDateString('pt-BR') %></td>
              <td><%= new Date(reserva.dataSaida).toString().slice(16,18) %>h</td>
              <td><%= new Date(reserva.dataChegada).toLocaleDateString('pt-BR') %></td>
              <td><%= new Date(reserva.dataChegada).toString().slice(16,18) %>h</td>
              <td>
                <a href="/reserva/admin/editar/<%=reserva.id%>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Editar reserva">
                  <i class="fas fa-edit"></i>
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- CARDS ‚Äì Mobile (abaixo de md) -->
    <div class="d-md-none">
      <div class="row g-3">
        <% reservas.forEach(function(reserva, i){ 
          let nome = reserva.cliente.nome.trim();
          let partes = nome.split(/\s+/);
          let primeiroNome = partes[0];
          let ultimoNome = partes.length > 1 ? partes[partes.length - 1] : "";

          let forma = reserva.pagamento.forma || '';
          let formaBadge = forma === 'PIX' ? 'bg-primary' : (forma === 'DINHEIRO' ? 'bg-warning text-dark' : 'bg-secondary');

          let sit = reserva.situacaoReserva;
          let sitLabel = (sit === 'APROVADO' ? 'Aprovado' : (sit === 'ANDAMENTO' ? 'Em andamento' : (sit === 'AGUARDANDO_ACEITACAO' ? 'Aguardando' : sit)));
          let sitBadge = (sit === 'APROVADO' ? 'bg-success' : (sit === 'ANDAMENTO' ? 'bg-info' : (sit === 'AGUARDANDO_ACEITACAO' ? 'bg-warning text-dark' : 'bg-secondary')));
        %>
        <div class="col-12">
          <div class="card reserva-card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1 text-primary fw-bold">
                    <i class="fas fa-user me-1"></i><%= primeiroNome %> <%= ultimoNome %>
                  </h6>
                  <div class="small text-muted">
                    <i class="fas fa-trailer me-1"></i><%= reserva.reboque.placa %>
                  </div>
                </div>
                <span class="badge <%= sitBadge %>"><%= sitLabel %></span>
              </div>

              <div class="mt-2 d-flex justify-content-between align-items-center">
                <div class="fw-bold fs-6 text-success">
                  R$ <%= (reserva.pagamento.valor).toFixed(2).replace('.',',') %>
                </div>
                <span class="badge <%= formaBadge %>"><%= forma %></span>
              </div>

              <button class="btn btn-sm btn-link px-0 mt-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#detalhes<%= i %>">
                Detalhes <i class="fas fa-chevron-down"></i>
              </button>

              <div id="detalhes<%= i %>" class="collapse">
                <hr class="my-2">
                <div class="small">
                  <div class="mb-1"><i class="fas fa-phone me-1"></i><%= reserva.cliente.telefone %></div>
                  <div class="mb-1">
                    <i class="fas fa-dollar-sign me-1"></i>Di√°ria:
                    R$ <%= (reserva.pagamento.valor/reserva.diarias).toFixed(2).replace('.',',') %>
                    <span class="ms-2"><i class="fas fa-clock me-1"></i>Dia(s): <%= reserva.diarias %></span>
                  </div>
                  <div class="mb-1">
                    <i class="fas fa-calendar-day me-1 text-success"></i>
                    In√≠cio: <%= new Date(reserva.dataSaida).toLocaleDateString('pt-BR') %>
                    <%= new Date(reserva.dataSaida).toString().slice(16,18) %>h
                  </div>
                  <div class="mb-1">
                    <i class="fas fa-calendar-check me-1 text-danger"></i>
                    Fim: <%= new Date(reserva.dataChegada).toLocaleDateString('pt-BR') %>
                    <%= new Date(reserva.dataChegada).toString().slice(16,18) %>h
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer bg-light d-flex justify-content-between">
              <div>
                <% if(reserva.situacaoReserva == 'APROVADO') { %>
                  <a href="/reserva/admin/situacao/<%=reserva.id%>/APROVADO" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-play me-1"></i>Iniciar
                  </a>
                <% } else if (reserva.situacaoReserva == 'ANDAMENTO') { %>
                  <a href="/reserva/admin/situacao/<%=reserva.id%>/ANDAMENTO" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-stop me-1"></i>Encerrar
                  </a>
                <% } else if(reserva.situacaoReserva == 'AGUARDANDO_ACEITACAO'){ %>
                  <form action="/reserva/admin/pagamento/dinheiro" method="POST" class="d-inline">
                    <input type="hidden" name="codigoPagamento" value="<%=reserva.pagamento.codigoPagamento%>">
                    <input type="hidden" name="valor" value="<%=reserva.pagamento.valor%>">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-check me-1"></i>Aprovar
                    </button>
                  </form>
                <% } else { %>
                  <span class="badge bg-primary"><i class="fas fa-qrcode me-1"></i>PIX</span>
                <% } %>
              </div>

              <a href="/reserva/admin/editar/<%=reserva.id%>" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Editar reserva">
                <i class="fas fa-edit"></i>
              </a>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <% if(mensagem && mensagem !== '') { %>
      <div class="alert alert-danger mt-3">
        <strong><%= mensagem %></strong>
      </div>
    <% } %>
  </div>
</div>

<!-- Estilo leve para os cards -->
<style>
  .reserva-card{border-radius:1rem;transition:transform .2s ease,box-shadow .2s ease}
  .reserva-card:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
</style>

                    
                </div>
            </div>
        </div>

        
    </div>

    <script>
        const ctx = document.getElementById('myChart');
        
        let dataJSON = document.getElementById('dataJSON');
        let dataArray = JSON.parse(dataJSON.value);
    
        // Obt√©m o nome do m√™s atual e o √∫ltimo dia do m√™s
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const now = new Date();
        const currentMonth = monthNames[now.getMonth()]; // Nome do m√™s atual
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); // √öltimo dia do m√™s
    
        // Paleta de cores para os reboques
        const colors = [
            'rgba(255, 99, 132, 0.2)',  // Vermelho
            'rgba(54, 162, 235, 0.2)',  // Azul
            'rgba(255, 206, 86, 0.2)',  // Amarelo
            'rgba(75, 192, 192, 0.2)',  // Verde √°gua
            'rgba(153, 102, 255, 0.2)', // Roxo
            'rgba(255, 159, 64, 0.2)'   // Laranja
        ];
    
        const borderColors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ];
    
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: dataArray.datasets.map((dataset, index) => ({
                    ...dataset,
                    backgroundColor: colors[index % colors.length],
                    borderColor: borderColors[index % borderColors.length],
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                })),
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        font: {
                            size: window.innerWidth < 600 ? 16 : 20,
                        },
                    },
                    legend: {
                        labels: {
                            font: {
                                size: window.innerWidth < 600 ? 10 : 14,
                            },
                        },
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += parseFloat(context.raw.y).toFixed(2);
                                return label;
                            },
                        },
                    },
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'linear',
                        min: 1, // Come√ßa no dia 1
                        max: lastDayOfMonth, // Termina no √∫ltimo dia do m√™s
                        // title: {
                        //     display: true,
                        //     text: 'M√™s de '+currentMonth, // Exibe o nome do m√™s atual
                        //     color: '#333',
                        //     font: {
                        //         size: 16,
                        //     },
                        // },
                        ticks: {
                            color: '#555',
                            stepSize: 1, // Garante que os ticks sejam por dia
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)',
                        },
                    },
                    y: {
                        beginAtZero: true,
                        // title: {
                        //     display: true,
                        //     text: 'Valor R$',
                        //     color: '#333',
                        //     font: {
                        //         size: 16,
                        //     },
                        // },
                        ticks: {
                            color: '#555',
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)',
                        },
                    },
                },
                animation: {
                    duration: 3000,
                    easing: 'easeOutBounce',
                },
            },
        });
    </script>
    
    
    <%-include('../../partials/footer.ejs')%>

</body>
</html>